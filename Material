/*Gradle Scripts > build.gradle.kts (Module :app)에
dependencies {
    // 이 두 줄을 추가해야 NavHost와 ViewModel을 사용할 수 있습니다.
    implementation("androidx.navigation:navigation-compose:2.7.7")
    implementation("androidx.lifecycle:lifecycle-viewmodel-compose:2.6.1")
}*/

package com.example.material // 사용자 프로젝트 환경에 맞게 수정됨

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.selection.selectable
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.Star // EmojiEvents 대신 사용
import androidx.compose.material.icons.filled.PlayArrow // Quiz 대신 사용
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import java.text.SimpleDateFormat
import java.util.*

// ------------------------------------------------------------------------
// 1. 데이터 모델 (Data)
// ------------------------------------------------------------------------

data class Question(
    val id: Int,
    val text: String,
    val options: List<String>,
    val correctIndex: Int
)

data class RankingEntry(
    val score: Int,
    val topic: String,
    val date: String
)

data class WrongAnswer(
    val question: Question,
    val selectedIndex: Int
)

// 퀴즈 데이터 저장소
object QuizRepository {
    val commonSense = listOf(
        Question(1, "대한민국의 수도는?", listOf("부산", "서울", "대구", "인천"), 1),
        Question(2, "사과를 영어로 하면?", listOf("Apple", "Banana", "Grape", "Orange"), 0),
        Question(3, "1 + 1 은?", listOf("1", "2", "3", "4"), 1)
    )
    val science = listOf(
        Question(1, "H2O는 무엇의 화학식인가?", listOf("산소", "수소", "물", "불"), 2),
        Question(2, "태양계에서 가장 큰 행성은?", listOf("지구", "목성", "화성", "금성"), 1),
        Question(3, "빛의 속도는 초속 약 몇 km인가?", listOf("30만", "10만", "50만", "무한"), 0)
    )
    val movie = listOf(
        Question(1, "영화 '기생충'의 감독은?", listOf("박찬욱", "봉준호", "김기덕", "류승완"), 1),
        Question(2, "마블의 아이언맨 주인공 배우는?", listOf("크리스 에반스", "로버트 다우니 주니어", "톰 홀랜드", "마크 러팔로"), 1),
        Question(3, "영화 '타이타닉'의 주제곡을 부른 가수는?", listOf("머라이어 캐리", "휘트니 휴스턴", "셀린 디온", "아델"), 2)
    )
}

// ------------------------------------------------------------------------
// 2. 상태 관리 클래스
// ------------------------------------------------------------------------
class QuizGameState {
    var currentScreen by mutableStateOf("main") // 화면 이동 상태

    var currentTopic by mutableStateOf("")
    var currentQuestionIndex by mutableIntStateOf(0)
    var score by mutableIntStateOf(0)
    var quizList by mutableStateOf<List<Question>>(emptyList())

    var wrongAnswers = mutableStateListOf<WrongAnswer>()
    var rankingList = mutableStateListOf<RankingEntry>()

    var selectedOptionIndex by mutableIntStateOf(-1)
    var isAnswerChecked by mutableStateOf(false)

    fun startQuiz(topic: String) {
        currentTopic = topic
        currentQuestionIndex = 0
        score = 0
        selectedOptionIndex = -1
        isAnswerChecked = false
        wrongAnswers.clear()

        quizList = when(topic) {
            "일반상식" -> QuizRepository.commonSense
            "과학" -> QuizRepository.science
            "영화" -> QuizRepository.movie
            else -> emptyList()
        }
        currentScreen = "quiz"
    }

    fun checkAnswer() {
        if (selectedOptionIndex == -1) return

        val currentQuestion = quizList[currentQuestionIndex]
        isAnswerChecked = true

        if (selectedOptionIndex == currentQuestion.correctIndex) {
            score += 10
        } else {
            wrongAnswers.add(WrongAnswer(currentQuestion, selectedOptionIndex))
        }
    }

    fun nextQuestion() {
        if (currentQuestionIndex < quizList.size - 1) {
            currentQuestionIndex++
            selectedOptionIndex = -1
            isAnswerChecked = false
        } else {
            saveRanking()
            currentScreen = "result"
        }
    }

    private fun saveRanking() {
        val sdf = SimpleDateFormat("MM-dd HH:mm", Locale.getDefault())
        val date = sdf.format(Date())
        rankingList.add(RankingEntry(score, currentTopic, date))
        rankingList.sortByDescending { it.score }
    }

    fun goMain() { currentScreen = "main" }
    fun goRanking() { currentScreen = "ranking" }
    fun goWrongNote() { currentScreen = "wrong_note" }
}

// ------------------------------------------------------------------------
// 3. UI 컴포저블
// ------------------------------------------------------------------------

@Composable
fun QuizAppWithoutLib() {
    val gameState = remember { QuizGameState() }

    when (gameState.currentScreen) {
        "main" -> MainScreen(gameState)
        "quiz" -> QuizScreen(gameState)
        "result" -> ResultScreen(gameState)
        "wrong_note" -> WrongNoteScreen(gameState)
        "ranking" -> RankingScreen(gameState)
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MainScreen(gameState: QuizGameState) {
    Scaffold(
        topBar = { CenterAlignedTopAppBar(title = { Text("퀴즈 마스터") }) }
    ) { padding ->
        Column(
            modifier = Modifier
                .padding(padding)
                .fillMaxSize()
                .padding(16.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.Center
        ) {
            // 아이콘을 기본 아이콘인 PlayArrow로 변경
            Icon(Icons.Default.PlayArrow, contentDescription = null, modifier = Modifier.size(80.dp), tint = MaterialTheme.colorScheme.primary)
            Spacer(modifier = Modifier.height(24.dp))
            Text("주제를 선택하세요", style = MaterialTheme.typography.headlineMedium)
            Spacer(modifier = Modifier.height(32.dp))

            val topics = listOf("일반상식", "과학", "영화")
            topics.forEach { topic ->
                Button(
                    onClick = { gameState.startQuiz(topic) },
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(vertical = 8.dp)
                        .height(60.dp),
                    shape = RoundedCornerShape(12.dp)
                ) {
                    Text(text = topic, fontSize = 20.sp)
                }
            }

            Spacer(modifier = Modifier.height(16.dp))
            OutlinedButton(
                onClick = { gameState.goRanking() },
                modifier = Modifier.fillMaxWidth()
            ) {
                Text("랭킹 보기")
            }
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun QuizScreen(gameState: QuizGameState) {
    val currentQuestion = gameState.quizList[gameState.currentQuestionIndex]

    Scaffold(
        topBar = {
            CenterAlignedTopAppBar(title = {
                Text("${gameState.currentTopic} ( ${gameState.currentQuestionIndex + 1} / ${gameState.quizList.size} )")
            })
        }
    ) { padding ->
        Column(
            modifier = Modifier
                .padding(padding)
                .fillMaxSize()
                .padding(16.dp)
        ) {
            LinearProgressIndicator(
                progress = { (gameState.currentQuestionIndex + 1) / gameState.quizList.size.toFloat() },
                modifier = Modifier.fillMaxWidth()
            )
            Spacer(modifier = Modifier.height(16.dp))

            Card(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(bottom = 24.dp),
                elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
            ) {
                Text(
                    text = currentQuestion.text,
                    style = MaterialTheme.typography.titleLarge,
                    modifier = Modifier.padding(24.dp)
                )
            }

            currentQuestion.options.forEachIndexed { index, option ->
                val isSelected = gameState.selectedOptionIndex == index
                val isCorrect = currentQuestion.correctIndex == index

                val backgroundColor = if (gameState.isAnswerChecked) {
                    if (isCorrect) Color.Green.copy(alpha = 0.2f)
                    else if (isSelected) Color.Red.copy(alpha = 0.2f)
                    else MaterialTheme.colorScheme.surface
                } else {
                    if (isSelected) MaterialTheme.colorScheme.primaryContainer else MaterialTheme.colorScheme.surface
                }

                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(vertical = 4.dp)
                        .background(backgroundColor, RoundedCornerShape(8.dp))
                        .selectable(
                            selected = isSelected,
                            onClick = {
                                if (!gameState.isAnswerChecked) gameState.selectedOptionIndex = index
                            }
                        )
                        .padding(16.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    RadioButton(
                        selected = isSelected,
                        onClick = null
                    )
                    Text(
                        text = option,
                        modifier = Modifier.padding(start = 8.dp),
                        fontSize = 18.sp
                    )
                }
            }

            Spacer(modifier = Modifier.weight(1f))

            Button(
                onClick = {
                    if (!gameState.isAnswerChecked) {
                        gameState.checkAnswer()
                    } else {
                        gameState.nextQuestion()
                    }
                },
                modifier = Modifier
                    .fillMaxWidth()
                    .height(56.dp),
                enabled = gameState.selectedOptionIndex != -1
            ) {
                Text(if (gameState.isAnswerChecked) "다음 문제" else "정답 확인")
            }
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ResultScreen(gameState: QuizGameState) {
    Scaffold(
        topBar = { CenterAlignedTopAppBar(title = { Text("퀴즈 결과") }) }
    ) { padding ->
        Column(
            modifier = Modifier
                .padding(padding)
                .fillMaxSize()
                .padding(16.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.Center
        ) {
            // 아이콘을 기본 아이콘인 Star로 변경
            Icon(Icons.Default.Star, contentDescription = null, modifier = Modifier.size(100.dp), tint = Color(0xFFFFD700))
            Spacer(modifier = Modifier.height(16.dp))
            Text("최종 점수", style = MaterialTheme.typography.headlineSmall)
            Text(
                text = "${gameState.score}점",
                style = MaterialTheme.typography.displayLarge,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.primary
            )
            Spacer(modifier = Modifier.height(32.dp))

            Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceEvenly) {
                Button(onClick = { gameState.goWrongNote() }) {
                    Text("오답 노트")
                }
                Button(onClick = { gameState.goRanking() }) {
                    Text("랭킹 보기")
                }
            }
            Spacer(modifier = Modifier.height(16.dp))
            OutlinedButton(
                onClick = { gameState.goMain() },
                modifier = Modifier.fillMaxWidth()
            ) {
                Text("메인 화면으로")
            }
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun WrongNoteScreen(gameState: QuizGameState) {
    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("오답 노트") },
                navigationIcon = {
                    IconButton(onClick = { gameState.currentScreen = "result" }) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "Back")
                    }
                }
            )
        }
    ) { padding ->
        if (gameState.wrongAnswers.isEmpty()) {
            Box(modifier = Modifier.padding(padding).fillMaxSize(), contentAlignment = Alignment.Center) {
                Text("틀린 문제가 없습니다! 완벽해요!")
            }
        } else {
            LazyColumn(
                modifier = Modifier.padding(padding),
                contentPadding = PaddingValues(16.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                items(gameState.wrongAnswers) { wrong ->
                    Card(elevation = CardDefaults.cardElevation(4.dp)) {
                        Column(modifier = Modifier.padding(16.dp)) {
                            Text(
                                text = "Q. ${wrong.question.text}",
                                style = MaterialTheme.typography.titleMedium,
                                fontWeight = FontWeight.Bold
                            )
                            Spacer(modifier = Modifier.height(8.dp))
                            Text(
                                text = "내 답: ${wrong.question.options[wrong.selectedIndex]}",
                                color = Color.Red
                            )
                            Text(
                                text = "정답: ${wrong.question.options[wrong.question.correctIndex]}",
                                color = Color.Blue,
                                fontWeight = FontWeight.Bold
                            )
                        }
                    }
                }
            }
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun RankingScreen(gameState: QuizGameState) {
    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("명예의 전당") },
                navigationIcon = {
                    IconButton(onClick = { gameState.goMain() }) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "Back")
                    }
                }
            )
        }
    ) { padding ->
        LazyColumn(
            modifier = Modifier.padding(padding),
            contentPadding = PaddingValues(16.dp),
            verticalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            item {
                Row(modifier = Modifier.fillMaxWidth().padding(8.dp)) {
                    Text("주제", modifier = Modifier.weight(1f), fontWeight = FontWeight.Bold)
                    Text("점수", modifier = Modifier.weight(1f), fontWeight = FontWeight.Bold)
                    Text("날짜", modifier = Modifier.weight(2f), fontWeight = FontWeight.Bold)
                }
                Divider()
            }
            items(gameState.rankingList) { rank ->
                Row(modifier = Modifier.fillMaxWidth().padding(8.dp)) {
                    Text(rank.topic, modifier = Modifier.weight(1f))
                    Text("${rank.score}점", modifier = Modifier.weight(1f))
                    Text(rank.date, modifier = Modifier.weight(2f))
                }
                Divider(color = Color.LightGray, thickness = 0.5.dp)
            }
        }
    }
}

// ------------------------------------------------------------------------
// MainActivity (엔트리 포인트)
// ------------------------------------------------------------------------

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            MaterialTheme {
                QuizAppWithoutLib()
            }
        }
    }
}
